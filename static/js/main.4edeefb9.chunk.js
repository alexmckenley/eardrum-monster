(this["webpackJsonpeardrum-monster"]=this["webpackJsonpeardrum-monster"]||[]).push([[0],{102:function(e,n,t){e.exports=t.p+"static/media/logo.86828523.png"},127:function(e,n,t){e.exports=t(207)},132:function(e,n,t){},133:function(e,n,t){},207:function(e,n,t){"use strict";t.r(n);var a=t(1),r=t.n(a),o=t(99),i=t.n(o),c=(t(132),t(19)),l=(t(133),t(100)),s=t(101),u=function(){function e(n){Object(l.a)(this,e),this.accessToken=n,this.freshAccessToken=!0,this.player=null}return Object(s.a)(e,[{key:"fetchState",value:function(){return this.player?this.player.getCurrentState():(console.error("Player not initialized"),Promise.reject("player not initialized"))}},{key:"handleNewState",value:function(n){var t=this,a=n.spotifyURI;this.player?this.fetchState().then((function(r){e.getUriFromState(r)!==a?t.play(a):Math.abs(n.position-r.position)>1e4&&t.seek(n.position)})):this.play(a)}},{key:"pause",value:function(){return this.player.pause()}},{key:"seek",value:function(e){return this.player.seek(e)}},{key:"nextTrack",value:function(){return this.player.nextTrack()}},{key:"play",value:function(e){return fetch("https://api.spotify.com/v1/me/player/play?device_id=".concat(this.deviceId),{method:"PUT",body:JSON.stringify({uris:[e]}),headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.accessToken)}}).then((function(e){e.ok||console.error("error playing uri")}))}},{key:"onPlayerStateChanged",value:function(n){var t=this;this.player.addListener("player_state_changed",(function(a){var r=e.getTrackFromState(a),o=e.getUriFromState(a);o===t.currentSongUri&&(r=null),t.currentSongUri=o,n({newState:a,newSong:r})}))}},{key:"prepareSpotifyClient",value:function(){var e=this;return new Promise((function(n){if(e.player)n();else{window.onSpotifyWebPlaybackSDKReady=function(){e.initializePlayer().then(n)};var t=document.createElement("script");t.src="https://sdk.scdn.co/spotify-player.js",document.body.appendChild(t)}}))}},{key:"initializePlayer",value:function(){var e=this;return new Promise((function(n){e.player=new window.Spotify.Player({name:"eardrum.monster",getOAuthToken:e.fetchOauthToken.bind(e),volume:.1}),e.player.on("initialization_error",(function(e){var n=e.message;console.error("Failed to initialize",n)})),e.player.on("authentication_error",(function(e){var n=e.message;console.error("Failed to authenticate",n)})),e.player.on("account_error",(function(e){var n=e.message;console.error("Failed to validate Spotify account",n)})),e.player.on("playback_error",(function(e){var n=e.message;console.error("Failed to perform playback",n)})),e.player.on("ready",(function(t){var a=t.device_id;e.deviceId=a,fetch("https://api.spotify.com/v1/me/player",{method:"PUT",body:JSON.stringify({device_ids:[e.deviceId],play:!0}),headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e.accessToken)}}).then((function(e){e.ok?n():console.error("unable to transfer playback to web player")}))})),e.player.connect().then((function(e){e||console.error("Failed to connect to the web player")}))}))}},{key:"fetchOauthToken",value:function(e){this.freshAccessToken||console.error("fetchOauthToken called more than once"),e(this.accessToken)}},{key:"fetchCurrentDeviceId",value:function(){return fetch("https://api.spotify.com/v1/me/player",{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.accessToken)}}).then((function(e){return e.ok||console.error("error fetching device id"),e.body.device&&e.body.device.id?(console.log("fetched device ID"),e.body.device.id):null}))}},{key:"fetchUserInfo",value:function(){return fetch("https://api.spotify.com/v1/me",{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.accessToken)}}).then((function(e){if(!e.ok)throw e;return e.json()}))}},{key:"setDeviceId",value:function(e){this.deviceId=e}}],[{key:"getTrackFromState",value:function(e){return e&&e.track_window&&e.track_window.current_track?e.track_window.current_track:null}},{key:"getUriFromState",value:function(e){return e&&e.track_window&&e.track_window.current_track?e.track_window.current_track.uri:null}},{key:"isAd",value:function(e){return!!(e&&e.track_window&&e.track_window.current_track)&&"ad"===e.track_window.current_track.type}}]),e}(),p=t(102),f=t.n(p),m=t(14);var d=function(e){var n=e.accessToken,t=e.clearAccessToken,a=e.username,o=encodeURIComponent("https://eardrum.monster/"),i="https://accounts.spotify.com/authorize?response_type=token&client_id=".concat("d73f9dfa97c44b57ac7cefcc031c4df9","&scope=").concat("streaming+user-read-email+user-read-private+user-read-playback-state+user-modify-playback-state+user-read-currently-playing","&redirect_uri=").concat(o);return r.a.createElement("header",{className:"App-header"},r.a.createElement(m.b,{className:"App-title",to:"/"},r.a.createElement("h1",null,"EARDRUM MONSTER")),r.a.createElement("img",{src:f.a,className:"App-logo",alt:"logo"}),null!=n?r.a.createElement(r.a.Fragment,null,r.a.createElement(m.b,{className:"App-link",to:"/u/".concat(a)},"/u/",a),r.a.createElement("a",{className:"App-link",href:"#",onClick:function(e){e.preventDefault(),t()}},"Logout")):r.a.createElement("a",{className:"App-link",href:i},"Login with Spotify"))};var h=function(e){var n=e.setAccessToken;return r.a.useEffect((function(){if(window.location.hash){var e={};window.location.hash.slice(1).split("&").map((function(e){return e.split("=")})).forEach((function(n){e[n[0]]=n[1]}));var t=e.access_token;window.location.hash="",n(t)}})),null},y=t(23),v=t(208),g=t(229),k=function(e){var n=e.songs;return r.a.createElement("div",null,r.a.createElement("h3",null,"Recently played"),r.a.createElement("ul",null,n.map((function(e){return r.a.createElement("li",{key:e.id},e.spotifyURI)}))))};function E(e){var n=e.song,t=e.spotify,a=r.a.useState(null),o=Object(c.a)(a,2),i=o[0],l=o[1];return r.a.useEffect((function(){t&&t.fetchCurrentDeviceId().then((function(e){return e?t.setDeviceId(e):t.prepareSpotifyClient()})).then((function(){return l(t.deviceId)}))}),[t]),r.a.useEffect((function(){t&&n&&i&&t.handleNewState(n)}),[n,i,t]),null}var w=function(e){var n=e.username,t=e.hostUsername,a=e.spotify;return r.a.createElement(r.a.Fragment,null,null!=n?r.a.createElement("div",null,"Listening to ",t,"'s channel!"):r.a.createElement("div",null,"Login to spotify to set the eardrum monster free"),r.a.createElement(g.a,{query:Object(v.b)("\n  query ListSongEvents(\n    $filter: ModelSongEventFilterInput\n    $limit: Int\n    $nextToken: String\n  ) {\n    listSongEvents(filter: $filter, limit: $limit, nextToken: $nextToken) {\n      items {\n        id\n        spotifyURI\n        timestamp\n        position\n        userID\n        user {\n          userID\n        }\n      }\n      nextToken\n    }\n  }\n",{filter:{userID:{eq:t}}}),subscription:Object(v.b)("\n  subscription OnCreateSongEvent($userID: String!) {\n    onCreateSongEvent(userID: $userID) {\n      id\n      spotifyURI\n      timestamp\n      position\n      userID\n      user {\n        userID\n        songEvents {\n          nextToken\n        }\n      }\n    }\n  }\n",{userID:t}),onSubscriptionMsg:function(e,n){var t=n.onCreateSongEvent;return e.listSongEvents.items.unshift(t),e.listSongEvents.items.length>50&&e.listSongEvents.items.pop(),e}},(function(e){var n,t=e.data,o=e.loading;if(e.error)return r.a.createElement("h3",null,"Error");if(o||!t)return r.a.createElement("h3",null,"Loading...");var i=null!==(n=t.listSongEvents&&t.listSongEvents.items)&&void 0!==n?n:[];return r.a.createElement(r.a.Fragment,null,r.a.createElement(E,{song:i[0],spotify:a}),r.a.createElement(k,{songs:i}))})))},S=t(16),b=t(118),I=t.n(b);var T=function(e){var n=e.username,t=e.spotify,a=r.a.useState(!1),o=Object(c.a)(a,2),i=o[0],l=o[1],s=r.a.useState(null),p=Object(c.a)(s,2),f=p[0],m=p[1],d=r.a.useRef(i);return d.current=i,r.a.useEffect((function(){n&&S.a.graphql(Object(v.b)("\n  mutation CreateUser(\n    $input: CreateUserInput!\n    $condition: ModelUserConditionInput\n  ) {\n    createUser(input: $input, condition: $condition) {\n      userID\n      songEvents {\n        items {\n          id\n          spotifyURI\n          timestamp\n          position\n          userID\n        }\n        nextToken\n      }\n    }\n  }\n",{input:{userID:n}})).catch((function(){return console.error("user creation failed")}))}),[n]),r.a.useEffect((function(){t&&n&&t.prepareSpotifyClient().then((function(){t.fetchState().then((function(e){return m(u.getUriFromState(e))})),t.onPlayerStateChanged((function(e){if(null!=e.newSong){var t,a={userID:n,timestamp:Math.floor(Date.now()/100),position:null!==(t=e.newState.position)&&void 0!==t?t:0,spotifyURI:e.newSong.uri};S.a.graphql(Object(v.b)("\n  mutation CreateSongEvent(\n    $input: CreateSongEventInput!\n    $condition: ModelSongEventConditionInput\n  ) {\n    createSongEvent(input: $input, condition: $condition) {\n      id\n      spotifyURI\n      timestamp\n      position\n      userID\n      user {\n        userID\n        songEvents {\n          nextToken\n        }\n      }\n    }\n  }\n",{input:a})).then((function(e){return console.log(e)})),m(e.newSong.uri)}}))}))}),[t,n]),r.a.useEffect((function(){if(i&&t){t.nextTrack();var e=setInterval((function(){d.current?t.nextTrack():clearInterval(e)}),5e3)}}),[i,d,t]),null==n?r.a.createElement("div",null,"Login to spotify to set the eardrum monster free"):null==t?r.a.createElement("div",null,"Initializing spotify web player..."):r.a.createElement(r.a.Fragment,null,r.a.createElement("label",null,r.a.createElement("span",null,"Power hour mode enabled"),r.a.createElement(I.a,{onChange:l,checked:i})),r.a.createElement("div",null,"broadcasting: ",f))};var _=function(e){var n=e.username,t=e.spotify,a=Object(y.f)().id;return n===a?r.a.createElement(T,{username:n,spotify:t}):r.a.createElement(w,{username:n,hostUsername:a,spotify:t})};var U=function(e){var n=e.username;return r.a.createElement("div",null,r.a.createElement("h2",null,"Currently broadcasting:"),r.a.createElement("ul",null,null!=n?r.a.createElement("li",null,r.a.createElement(m.b,{className:"App-link",to:"/u/".concat(n)},"/u/",n)):null,r.a.createElement("li",null,r.a.createElement(m.b,{to:"/u/alta"},"/u/alta")),r.a.createElement("li",null,r.a.createElement(m.b,{to:"/u/hajkowicz"},"/u/hajkowicz")),r.a.createElement("li",null,r.a.createElement(m.b,{to:"/u/cilo"},"/u/cilo"))))},j={aws_project_region:"us-east-1",aws_appsync_graphqlEndpoint:"https://kponrlcw6jap7j62gb56h2abf4.appsync-api.us-east-1.amazonaws.com/graphql",aws_appsync_region:"us-east-1",aws_appsync_authenticationType:"API_KEY",aws_appsync_apiKey:"da2-jxgfvq7zzvacfozrt7vucdiipq"};t(42).default.configure(j);var C=function(){var e=window.localStorage.getItem("spotifyAccessToken"),n=window.localStorage.getItem("spotifyUsername"),t=r.a.useState(e),a=Object(c.a)(t,2),o=a[0],i=a[1],l=r.a.useState(n),s=Object(c.a)(l,2),p=s[0],f=s[1],v=r.a.useState(null),g=Object(c.a)(v,2),k=g[0],E=g[1];function w(){console.log("clearing"),window.localStorage.removeItem("spotifyAccessToken"),window.localStorage.removeItem("spotifyUsername"),i(null),f(null)}return r.a.useEffect((function(){if(o){var e=new u(o);console.log(e),E(e),e.fetchUserInfo().then((function(e){!function(e){window.localStorage.setItem("spotifyUsername",e),f(e)}(e.id)})).catch((function(){w()}))}}),[o]),r.a.createElement("div",{className:"App"},r.a.createElement(m.a,null,r.a.createElement(h,{setAccessToken:function(e){window.localStorage.setItem("spotifyAccessToken",e),i(e)}}),r.a.createElement(d,{clearAccessToken:w,accessToken:o,username:p}),r.a.createElement(y.c,null,r.a.createElement(y.a,{exact:!0,path:"/"},r.a.createElement(U,{username:p})),r.a.createElement(y.a,{path:"/u/:id"},r.a.createElement(_,{username:p,spotify:k})))))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));i.a.render(r.a.createElement(r.a.StrictMode,null,r.a.createElement(C,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[127,1,2]]]);
//# sourceMappingURL=main.4edeefb9.chunk.js.map