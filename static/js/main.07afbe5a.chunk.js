(this["webpackJsonpeardrum-monster"]=this["webpackJsonpeardrum-monster"]||[]).push([[0],{128:function(e,n,t){e.exports=t(212)},133:function(e,n,t){},134:function(e,n,t){},139:function(e,n,t){},140:function(e,n,t){},210:function(e,n,t){},211:function(e,n,t){},212:function(e,n,t){"use strict";t.r(n);var a=t(1),r=t.n(a),o=t(100),i=t.n(o),c=(t(133),t(15)),s=(t(134),t(101)),l=t(102),u=function(){function e(n){Object(s.a)(this,e),this.accessToken=n,this.freshAccessToken=!0,this.player=null}return Object(l.a)(e,[{key:"fetchState",value:function(){return this.player?this.player.getCurrentState():(console.error("Player not initialized"),Promise.reject("player not initialized"))}},{key:"handleNewState",value:function(n){var t=this,a=n.spotifyURI;this.player?this.fetchState().then((function(r){e.getUriFromState(r)!==a?t.play(a):Math.abs(n.position-r.position)>1e4&&t.seek(n.position)})):this.play(a)}},{key:"pause",value:function(){return this.player.pause()}},{key:"seek",value:function(e){return this.player.seek(e)}},{key:"nextTrack",value:function(){return this.player.nextTrack()}},{key:"play",value:function(e){return fetch("https://api.spotify.com/v1/me/player/play?device_id=".concat(this.deviceId),{method:"PUT",body:JSON.stringify({uris:[e]}),headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.accessToken)}}).then((function(e){e.ok||console.error("error playing uri")}))}},{key:"onPlayerStateChanged",value:function(e){this.player.addListener("player_state_changed",e)}},{key:"prepareSpotifyClient",value:function(){var e=this;return new Promise((function(n){if(e.player)n();else{window.onSpotifyWebPlaybackSDKReady=function(){e.initializePlayer().then(n)};var t=document.createElement("script");t.src="https://sdk.scdn.co/spotify-player.js",document.body.appendChild(t)}}))}},{key:"initializePlayer",value:function(){var e=this;return new Promise((function(n){e.player=new window.Spotify.Player({name:"eardrum.monster",getOAuthToken:e.fetchOauthToken.bind(e),volume:.1}),e.player.on("initialization_error",(function(e){var n=e.message;console.error("Failed to initialize",n)})),e.player.on("authentication_error",(function(e){var n=e.message;console.error("Failed to authenticate",n)})),e.player.on("account_error",(function(e){var n=e.message;console.error("Failed to validate Spotify account",n)})),e.player.on("playback_error",(function(e){var n=e.message;console.error("Failed to perform playback",n)})),e.player.on("ready",(function(t){var a=t.device_id;e.deviceId=a,fetch("https://api.spotify.com/v1/me/player",{method:"PUT",body:JSON.stringify({device_ids:[e.deviceId],play:!0}),headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e.accessToken)}}).then((function(e){e.ok?n():console.error("unable to transfer playback to web player")}))})),e.player.connect().then((function(e){e||console.error("Failed to connect to the web player")}))}))}},{key:"fetchOauthToken",value:function(e){this.freshAccessToken||console.error("fetchOauthToken called more than once"),e(this.accessToken)}},{key:"fetchCurrentDeviceId",value:function(){return fetch("https://api.spotify.com/v1/me/player",{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.accessToken)}}).then((function(e){return e.ok||console.error("error fetching device id"),204===e.status?{}:e.json()})).then((function(e){return e.device&&e.device.id?e.device.id:null}))}},{key:"fetchUserInfo",value:function(){return fetch("https://api.spotify.com/v1/me",{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.accessToken)}}).then((function(e){if(!e.ok)throw e;return e.json()}))}},{key:"setDeviceId",value:function(e){this.deviceId=e}}],[{key:"getTrackFromState",value:function(e){return e&&e.track_window&&e.track_window.current_track?e.track_window.current_track:null}},{key:"getUriFromState",value:function(e){return e&&e.track_window&&e.track_window.current_track?e.track_window.current_track.uri:null}},{key:"isAd",value:function(e){return!!(e&&e.track_window&&e.track_window.current_track)&&"ad"===e.track_window.current_track.type}}]),e}(),m=t(45),p=t.n(m),f=t(21);var d=function(e){var n=e.accessToken,t=e.clearAccessToken,a=e.username,o=encodeURIComponent("https://eardrum.monster/"),i="https://accounts.spotify.com/authorize?response_type=token&client_id=".concat("d73f9dfa97c44b57ac7cefcc031c4df9","&scope=").concat("streaming+user-read-email+user-read-private+user-read-playback-state+user-modify-playback-state+user-read-currently-playing","&redirect_uri=").concat(o);return r.a.createElement("header",{className:"App-header"},r.a.createElement(f.b,{className:"App-title",to:"/"},r.a.createElement("h1",null,"EARDRUM MONSTER")),r.a.createElement("img",{src:p.a,className:"App-logo",alt:"logo"}),null!=n?r.a.createElement(r.a.Fragment,null,r.a.createElement(f.b,{className:"App-link",to:"/u/".concat(a)},"/u/",a),r.a.createElement("a",{className:"App-link",href:"#",onClick:function(e){e.preventDefault(),t()}},"Logout")):r.a.createElement("a",{className:"App-link",href:i},"Login with Spotify"))};var h=function(e){var n=e.setAccessToken;return r.a.useEffect((function(){if(window.location.hash){var e={};window.location.hash.slice(1).split("&").map((function(e){return e.split("=")})).forEach((function(n){e[n[0]]=n[1]}));var t=e.access_token;window.location.hash="",n(t)}})),null},v=t(23),y=t(16),k=t(213),g=t(233);t(139);var E=function(e){var n,t,a=e.track;return console.log(a),r.a.createElement("div",{className:"Track"},r.a.createElement("img",{className:"Track-albumImg",src:null!==(n=null===a||void 0===a?void 0:a.albumImg)&&void 0!==n?n:p.a,alt:"Album art"}),r.a.createElement("div",{className:"Track-details"},r.a.createElement("p",{className:"Track-name"},null!==(t=null===a||void 0===a?void 0:a.name)&&void 0!==t?t:"Unknown"),r.a.createElement("p",{className:"Track-artist"},null===a||void 0===a?void 0:a.artistName)))},I=(t(140),"\n  query SongEventsByUserId(\n    $userID: String\n    $timestamp: ModelIntKeyConditionInput\n    $sortDirection: ModelSortDirection\n    $filter: ModelSongEventFilterInput\n    $limit: Int\n    $nextToken: String\n  ) {\n    songEventsByUserID(\n      userID: $userID\n      timestamp: $timestamp\n      sortDirection: $sortDirection\n      filter: $filter\n      limit: $limit\n      nextToken: $nextToken\n    ) {\n      items {\n        id\n        spotifyURI\n        timestamp\n        position\n        track {\n          uri\n          trackID\n          name\n          durationMs\n          albumName\n          artistName\n          albumImg\n        }\n        userID\n        user {\n          userID\n          latestEvent\n        }\n      }\n      nextToken\n    }\n  }\n"),b="\n  mutation CreateSongEvent(\n    $input: CreateSongEventInput!\n    $condition: ModelSongEventConditionInput\n  ) {\n    createSongEvent(input: $input, condition: $condition) {\n      id\n      spotifyURI\n      timestamp\n      position\n      track {\n        uri\n        trackID\n        name\n        durationMs\n        albumName\n        artistName\n        albumImg\n      }\n      userID\n      user {\n        userID\n        latestEvent\n        songEvents {\n          nextToken\n        }\n      }\n    }\n  }\n",w=function(e){var n=e.songs;return r.a.createElement(r.a.Fragment,null,r.a.createElement("h3",null,"Recently played tracks"),n.map((function(e){return r.a.createElement("div",{key:e.id,className:"Listen-track"},r.a.createElement(E,{track:e.track}))})))};function D(e){var n=e.song,t=e.spotify,a=r.a.useState(null),o=Object(c.a)(a,2),i=o[0],s=o[1];return r.a.useEffect((function(){t&&t.fetchCurrentDeviceId().then((function(e){return e?t.setDeviceId(e):t.prepareSpotifyClient()})).then((function(){return s(t.deviceId)}))}),[t]),r.a.useEffect((function(){t&&n&&i&&t.handleNewState(n)}),[n,i,t]),null}function T(e){var n=e.hostUsername;return r.a.useEffect((function(){var e=setInterval((function(){var e={userID:n,timestamp:Math.floor(Date.now()/100),position:0,spotifyURI:["spotify:track:08KMh61hPslT7sEf2tEgtT","spotify:track:4mFDsq9pt9msJ9ywYvBzHo","spotify:track:59nNxS2V7M4UDH058BU5qJ","spotify:track:1CkrhTdtRhUzPmA8qtr6y6","spotify:track:4mFDsq9pt9msJ9ywYvBzHo","spotify:track:6AynxUt8LJy9S6bovDdFLr","spotify:track:000PzErbB04ALQCv9iYiQm","spotify:track:6AynxUt8LJy9S6bovDdFLr","spotify:track:7JGepQzDnQDYeGxLCTBSsG","spotify:track:4PPrsYpzuRqe4QoCDGAG4b"][(100*Math.random()).toString()[0]]};y.a.graphql(Object(k.b)(b,{input:e})).then((function(e){return console.log("Publishing: ",e)}))}),5e3);return function(){clearInterval(e)}}),[n]),r.a.createElement("h1",null,"DevPublisher enabled")}var S=function(e){var n=e.username,t=e.hostUsername,a=e.spotify,o=window.location.search.includes("DEV=1");return r.a.createElement("div",{className:"Listen"},r.a.createElement("div",{className:"Listen-header"},null!=n?r.a.createElement("div",null,"Listening to ",t,"'s channel!"):r.a.createElement("div",null,"Login to spotify to set the eardrum monster free"),o&&r.a.createElement(T,{hostUsername:t})),r.a.createElement("div",{className:"Listen-trackList"},r.a.createElement(g.a,{query:Object(k.b)(I,{userID:t,sortDirection:"DESC",limit:50}),subscription:Object(k.b)("\n  subscription OnCreateSongEvent($userID: String!) {\n    onCreateSongEvent(userID: $userID) {\n      id\n      spotifyURI\n      timestamp\n      position\n      track {\n        uri\n        trackID\n        name\n        durationMs\n        albumName\n        artistName\n        albumImg\n      }\n      userID\n      user {\n        userID\n        latestEvent\n        songEvents {\n          nextToken\n        }\n      }\n    }\n  }\n",{userID:t}),onSubscriptionMsg:function(e,n){var t=n.onCreateSongEvent;return e.songEventsByUserID.items.unshift(t),e.songEventsByUserID.items.length>50&&e.songEventsByUserID.items.pop(),e}},(function(e){var n,t=e.data,o=e.loading;if(e.error)return r.a.createElement("h3",null,"Error");if(o||!t)return r.a.createElement("h3",null,"Loading...");var i=null!==(n=t.songEventsByUserID&&t.songEventsByUserID.items)&&void 0!==n?n:[];return r.a.createElement(r.a.Fragment,null,r.a.createElement(D,{song:i[0],spotify:a}),r.a.createElement(w,{songs:i}))}))))},U=t(118),N=t.n(U);t(210);var _=function(e){var n=e.username,t=e.spotify,a=r.a.useState(!1),o=Object(c.a)(a,2),i=o[0],s=o[1],l=r.a.useState(1),m=Object(c.a)(l,2),p=m[0],f=m[1],d=r.a.useState(null),h=Object(c.a)(d,2),v=h[0],g=h[1],w=r.a.useRef(i),D=r.a.useRef(null);return w.current=i,D.current=function(e){var t,a=u.getTrackFromState(e);if(console.log("handling state change",a,v),null!=a&&a.uri!==(null===v||void 0===v?void 0:v.uri)){var r={userID:n,timestamp:Math.floor(Date.now()/100),position:null!==(t=e.position)&&void 0!==t?t:0,spotifyURI:a.uri},o={uri:a.uri,trackID:a.id,name:a.name,durationMs:a.duration_ms,albumName:a.album.name,artistName:a.artists[0].name,albumImg:a.album.images[0].url};g(o),function(e){return y.a.graphql(Object(k.b)("\n  mutation CreateTrack(\n    $input: CreateTrackInput!\n    $condition: ModelTrackConditionInput\n  ) {\n    createTrack(input: $input, condition: $condition) {\n      uri\n      trackID\n      name\n      durationMs\n      albumName\n      artistName\n      albumImg\n    }\n  }\n",{input:e}))}(o).then((function(){return function(e){return y.a.graphql(Object(k.b)(b,{input:e}))}(r)}))}},r.a.useEffect((function(){n&&y.a.graphql(Object(k.b)("\n  mutation CreateUser(\n    $input: CreateUserInput!\n    $condition: ModelUserConditionInput\n  ) {\n    createUser(input: $input, condition: $condition) {\n      userID\n      latestEvent\n      songEvents {\n        items {\n          id\n          spotifyURI\n          timestamp\n          position\n          userID\n        }\n        nextToken\n      }\n    }\n  }\n",{input:{userID:n}})).catch((function(){return console.error("user creation failed")}))}),[n]),r.a.useEffect((function(){if(t&&n){var e=y.a.graphql(Object(k.b)(I,{userID:n,sortDirection:"DESC",limit:1})).catch((function(){return console.error("user creation failed")}));return Promise.all([t.prepareSpotifyClient(),e]).then((function(e){var n,a,r=Object(c.a)(e,2),o=(r[0],r[1]),i=null===o||void 0===o||null===(n=o.data)||void 0===n||null===(a=n.songEventsByUserID)||void 0===a?void 0:a.items[0];null!==i&&g(i.track),t.fetchState().then((function(e){return D.current(e)})),t.onPlayerStateChanged((function(e){return D.current(e)}))})),function(){D.current=function(){}}}}),[t,n]),r.a.useEffect((function(){if(i&&t){t.nextTrack();var e=setInterval((function(){w.current?(f((function(e){return e+1})),t.nextTrack()):(clearInterval(e),f(1))}),6e4)}}),[i,w,t]),null==n?r.a.createElement("div",null,"Login to spotify to set the eardrum monster free"):null==t||null==v?r.a.createElement("div",{className:"Broadcast"},"Initializing spotify web player..."):r.a.createElement("div",{className:"Broadcast"},r.a.createElement("div",{className:"Broadcast-controls"},r.a.createElement("label",{htmlFor:"phToggle"},"Power hour mode"),r.a.createElement(N.a,{className:"Broadcast-switch",id:"phToggle",onChange:s,checked:i})),i&&r.a.createElement("h1",null,p),r.a.createElement("h1",null,"Connected."),r.a.createElement("p",null,"Now Playing:"),r.a.createElement("div",{className:"Broadcast-currentTrack"},r.a.createElement(E,{track:v})))};var $=function(e){var n=e.username,t=e.spotify,a=Object(v.f)().id;return n===a?r.a.createElement(_,{username:n,spotify:t}):r.a.createElement(S,{username:n,hostUsername:a,spotify:t})},C=(t(211),function(e){var n=e.users;return r.a.createElement("ul",{className:"Home-userList"},n.map((function(e){return r.a.createElement("li",{key:e.userID},r.a.createElement(f.b,{className:"Home-link",to:"/u/".concat(e.userID)},"\ud83d\udc42 /u/",e.userID))})))});var j=function(e){return e.username,r.a.createElement("div",{className:"Home"},r.a.createElement(g.a,{query:Object(k.b)("\n  query ListUsers(\n    $userID: String\n    $filter: ModelUserFilterInput\n    $limit: Int\n    $nextToken: String\n    $sortDirection: ModelSortDirection\n  ) {\n    listUsers(\n      userID: $userID\n      filter: $filter\n      limit: $limit\n      nextToken: $nextToken\n      sortDirection: $sortDirection\n    ) {\n      items {\n        userID\n        latestEvent\n        songEvents {\n          nextToken\n        }\n      }\n      nextToken\n    }\n  }\n",{limit:50}),subscription:Object(k.b)("\n  subscription OnUpdateUser {\n    onUpdateUser {\n      userID\n      latestEvent\n      songEvents {\n        items {\n          id\n          spotifyURI\n          timestamp\n          position\n          userID\n        }\n        nextToken\n      }\n    }\n  }\n"),onSubscriptionMsg:function(e,n){var t=n.onUserUpdate;return console.log("onUserUpdate",t),e}},(function(e){var n,t=e.data,a=e.loading;if(e.error)return r.a.createElement("h3",null,"Error");if(a||!t)return r.a.createElement("h3",null,"Loading...");var o=null!==(n=t.listUsers&&t.listUsers.items)&&void 0!==n?n:[];return r.a.createElement(r.a.Fragment,null,r.a.createElement("h2",null,"\ud83d\ude08 MONSTER LIST \ud83d\ude08"),r.a.createElement(C,{users:o}))})))},A={aws_project_region:"us-east-1",aws_appsync_graphqlEndpoint:"https://kponrlcw6jap7j62gb56h2abf4.appsync-api.us-east-1.amazonaws.com/graphql",aws_appsync_region:"us-east-1",aws_appsync_authenticationType:"API_KEY",aws_appsync_apiKey:"da2-jxgfvq7zzvacfozrt7vucdiipq"};t(36).default.configure(A);var O=function(){var e=window.localStorage.getItem("spotifyAccessToken"),n=window.localStorage.getItem("spotifyUsername"),t=r.a.useState(e),a=Object(c.a)(t,2),o=a[0],i=a[1],s=r.a.useState(n),l=Object(c.a)(s,2),m=l[0],p=l[1],y=r.a.useState(null),k=Object(c.a)(y,2),g=k[0],E=k[1];function I(){window.localStorage.removeItem("spotifyAccessToken"),window.localStorage.removeItem("spotifyUsername"),i(null),p(null)}return r.a.useEffect((function(){if(o){var e=new u(o);E(e),e.fetchUserInfo().then((function(e){!function(e){window.localStorage.setItem("spotifyUsername",e),p(e)}(e.id)})).catch((function(){I()}))}}),[o]),r.a.createElement("div",{className:"App"},r.a.createElement(f.a,null,r.a.createElement(h,{setAccessToken:function(e){window.localStorage.setItem("spotifyAccessToken",e),i(e)}}),r.a.createElement(d,{clearAccessToken:I,accessToken:o,username:m}),r.a.createElement("div",{className:"App-content"},r.a.createElement(v.c,null,r.a.createElement(v.a,{exact:!0,path:"/"},r.a.createElement(j,{username:m})),r.a.createElement(v.a,{path:"/u/:id"},r.a.createElement($,{username:m,spotify:g}))))))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));i.a.render(r.a.createElement(r.a.StrictMode,null,r.a.createElement(O,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},45:function(e,n,t){e.exports=t.p+"static/media/logo.86828523.png"}},[[128,1,2]]]);
//# sourceMappingURL=main.07afbe5a.chunk.js.map