(this["webpackJsonpeardrum-monster"]=this["webpackJsonpeardrum-monster"]||[]).push([[0],{102:function(e,n,t){e.exports=t.p+"static/media/logo.86828523.png"},126:function(e,n,t){e.exports=t(205)},131:function(e,n,t){},132:function(e,n,t){},205:function(e,n,t){"use strict";t.r(n);var a=t(1),o=t.n(a),r=t(99),i=t.n(r),c=(t(131),t(34)),s=(t(132),t(100)),l=t(101),u=function(){function e(n){Object(s.a)(this,e),this.accessToken=n,this.freshAccessToken=!0,this.player=null}return Object(l.a)(e,[{key:"fetchState",value:function(){return this.player?this.player.getCurrentState():(console.error("Player not initialized"),Promise.reject("player not initialized"))}},{key:"handleNewState",value:function(n){var t=this,a=n.spotifyURI;this.player?this.fetchState().then((function(o){e.getUriFromState(o)!==a?t.play(a):Math.abs(n.position-o.position)>1e4&&t.seek(n.position)})):this.play(a)}},{key:"pause",value:function(){return this.player.pause()}},{key:"seek",value:function(e){return this.player.seek(e)}},{key:"play",value:function(e){return fetch("https://api.spotify.com/v1/me/player/play?device_id=".concat(this.deviceId),{method:"PUT",body:JSON.stringify({uris:[e]}),headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.accessToken)}}).then((function(e){e.ok||console.error("error playing uri")}))}},{key:"onPlayerStateChanged",value:function(n){var t=this;this.player.addListener("player_state_changed",(function(a){var o=e.getTrackFromState(a),r=e.getUriFromState(a);r===t.currentSongUri&&(o=null),t.currentSongUri=r,n({newState:a,newSong:o})}))}},{key:"prepareSpotifyClient",value:function(){var e=this;return new Promise((function(n){if(e.player)n();else{window.onSpotifyWebPlaybackSDKReady=function(){e.initializePlayer().then(n)};var t=document.createElement("script");t.src="https://sdk.scdn.co/spotify-player.js",document.body.appendChild(t)}}))}},{key:"initializePlayer",value:function(){var e=this;return new Promise((function(n){e.player=new window.Spotify.Player({name:"eardrum.monster",getOAuthToken:e.fetchOauthToken.bind(e),volume:.1}),e.player.on("initialization_error",(function(e){var n=e.message;console.error("Failed to initialize",n)})),e.player.on("authentication_error",(function(e){var n=e.message;console.error("Failed to authenticate",n)})),e.player.on("account_error",(function(e){var n=e.message;console.error("Failed to validate Spotify account",n)})),e.player.on("playback_error",(function(e){var n=e.message;console.error("Failed to perform playback",n)})),e.player.on("ready",(function(t){var a=t.device_id;e.deviceId=a,fetch("https://api.spotify.com/v1/me/player",{method:"PUT",body:JSON.stringify({device_ids:[e.deviceId],play:!0}),headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e.accessToken)}}).then((function(e){e.ok?n():console.error("unable to transfer playback to web player")}))})),e.player.connect().then((function(e){e||console.error("Failed to connect to the web player")}))}))}},{key:"fetchOauthToken",value:function(e){this.freshAccessToken||console.error("fetchOauthToken called more than once"),e(this.accessToken)}},{key:"fetchCurrentDeviceId",value:function(){return fetch("https://api.spotify.com/v1/me/player",{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.accessToken)}}).then((function(e){return e.ok||console.error("error fetching device id"),e.body.device&&e.body.device.id?(console.log("fetched device ID"),e.body.device.id):null}))}},{key:"fetchUserInfo",value:function(){return fetch("https://api.spotify.com/v1/me",{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.accessToken)}}).then((function(e){if(!e.ok)throw e;return e.json()}))}},{key:"setDeviceId",value:function(e){this.deviceId=e}}],[{key:"getTrackFromState",value:function(e){return e&&e.track_window&&e.track_window.current_track?e.track_window.current_track:null}},{key:"getUriFromState",value:function(e){return e&&e.track_window&&e.track_window.current_track?e.track_window.current_track.uri:null}},{key:"isAd",value:function(e){return!!(e&&e.track_window&&e.track_window.current_track)&&"ad"===e.track_window.current_track.type}}]),e}(),p=t(102),f=t.n(p),m=t(14);var d=function(e){var n=e.accessToken,t=e.clearAccessToken,a=e.username,r=encodeURIComponent("https://eardrum.monster/"),i="https://accounts.spotify.com/authorize?response_type=token&client_id=".concat("d73f9dfa97c44b57ac7cefcc031c4df9","&scope=").concat("streaming+user-read-email+user-read-private+user-read-playback-state+user-modify-playback-state+user-read-currently-playing","&redirect_uri=").concat(r);return o.a.createElement("header",{className:"App-header"},o.a.createElement(m.b,{className:"App-title",to:"/"},o.a.createElement("h1",null,"EARDRUM MONSTER")),o.a.createElement("img",{src:f.a,className:"App-logo",alt:"logo"}),null!=n?o.a.createElement(o.a.Fragment,null,o.a.createElement(m.b,{className:"App-link",to:"/u/".concat(a)},"/u/",a),o.a.createElement("a",{className:"App-link",href:"#",onClick:function(e){e.preventDefault(),t()}},"Logout")):o.a.createElement("a",{className:"App-link",href:i},"Login with Spotify"))};var h=function(e){var n=e.setAccessToken;return o.a.useEffect((function(){if(window.location.hash){var e={};window.location.hash.slice(1).split("&").map((function(e){return e.split("=")})).forEach((function(n){e[n[0]]=n[1]}));var t=e.access_token;window.location.hash="",n(t)}})),null},y=t(22),v=t(206),g=t(227),k=function(e){var n=e.songs;return o.a.createElement("div",null,o.a.createElement("h3",null,"Recently played"),o.a.createElement("ul",null,n.map((function(e){return o.a.createElement("li",{key:e.id},e.spotifyURI)}))))};function E(e){var n=e.song,t=e.spotify,a=o.a.useState(null),r=Object(c.a)(a,2),i=r[0],s=r[1];return o.a.useEffect((function(){t&&t.fetchCurrentDeviceId().then((function(e){return e?t.setDeviceId(e):t.prepareSpotifyClient()})).then((function(){return s(t.deviceId)}))}),[t]),o.a.useEffect((function(){t&&n&&i&&t.handleNewState(n)}),[n,i,t]),null}var w=function(e){var n=e.username,t=e.hostUsername,a=e.spotify;return o.a.createElement(o.a.Fragment,null,null!=n?o.a.createElement("div",null,"Listening to ",t,"'s channel!"):o.a.createElement("div",null,"Login to spotify to set the eardrum monster free"),o.a.createElement(g.a,{query:Object(v.b)("\n  query ListSongEvents(\n    $filter: ModelSongEventFilterInput\n    $limit: Int\n    $nextToken: String\n  ) {\n    listSongEvents(filter: $filter, limit: $limit, nextToken: $nextToken) {\n      items {\n        id\n        spotifyURI\n        timestamp\n        position\n        userID\n        user {\n          userID\n        }\n      }\n      nextToken\n    }\n  }\n",{filter:{userID:{eq:t}}}),subscription:Object(v.b)("\n  subscription OnCreateSongEvent($userID: String!) {\n    onCreateSongEvent(userID: $userID) {\n      id\n      spotifyURI\n      timestamp\n      position\n      userID\n      user {\n        userID\n        songEvents {\n          nextToken\n        }\n      }\n    }\n  }\n",{userID:t}),onSubscriptionMsg:function(e,n){var t=n.onCreateSongEvent;return e.listSongEvents.items.unshift(t),e.listSongEvents.items.length>50&&e.listSongEvents.items.pop(),e}},(function(e){var n,t=e.data,r=e.loading;if(e.error)return o.a.createElement("h3",null,"Error");if(r||!t)return o.a.createElement("h3",null,"Loading...");var i=null!==(n=t.listSongEvents&&t.listSongEvents.items)&&void 0!==n?n:[];return o.a.createElement(o.a.Fragment,null,o.a.createElement(E,{song:i[0],spotify:a}),o.a.createElement(k,{songs:i}))})))},S=t(16);var I=function(e){var n=e.username,t=e.spotify;return o.a.useEffect((function(){n&&S.a.graphql(Object(v.b)("\n  mutation CreateUser(\n    $input: CreateUserInput!\n    $condition: ModelUserConditionInput\n  ) {\n    createUser(input: $input, condition: $condition) {\n      userID\n      songEvents {\n        items {\n          id\n          spotifyURI\n          timestamp\n          position\n          userID\n        }\n        nextToken\n      }\n    }\n  }\n",{input:{userID:n}})).catch((function(){return console.error("user creation failed")}))}),[n]),o.a.useEffect((function(){t&&n&&t.prepareSpotifyClient().then((function(){return setInterval((function(){return t.fetchState().then((function(e){return console.log(e)}))}),2e3)})).then((function(e){t.onPlayerStateChanged((function(e){if(null!=e.newSong){var t,a={userID:n,timestamp:Math.floor(Date.now()/100),position:null!==(t=e.newState.position)&&void 0!==t?t:0,spotifyURI:e.newSong.uri};S.a.graphql(Object(v.b)("\n  mutation CreateSongEvent(\n    $input: CreateSongEventInput!\n    $condition: ModelSongEventConditionInput\n  ) {\n    createSongEvent(input: $input, condition: $condition) {\n      id\n      spotifyURI\n      timestamp\n      position\n      userID\n      user {\n        userID\n        songEvents {\n          nextToken\n        }\n      }\n    }\n  }\n",{input:a})).then((function(e){return console.log(e)}))}}))}))}),[t,n]),null==n?o.a.createElement("div",null,"Login to spotify to set the eardrum monster free"):t?o.a.createElement("div",null,"broadcasting los master PLUS. "):o.a.createElement("div",null,"Initializing spotify web player...")};var b=function(e){var n=e.username,t=e.spotify,a=Object(y.f)().id;return n===a?o.a.createElement(I,{username:n,spotify:t}):o.a.createElement(w,{username:n,hostUsername:a,spotify:t})};var T=function(e){var n=e.username;return o.a.createElement("div",null,o.a.createElement("h2",null,"Currently broadcasting:"),o.a.createElement("ul",null,null!=n?o.a.createElement("li",null,o.a.createElement(m.b,{className:"App-link",to:"/u/".concat(n)},"/u/",n)):null,o.a.createElement("li",null,o.a.createElement(m.b,{to:"/u/alta"},"/u/alta")),o.a.createElement("li",null,o.a.createElement(m.b,{to:"/u/hajkowicz"},"/u/hajkowicz")),o.a.createElement("li",null,o.a.createElement(m.b,{to:"/u/cilo"},"/u/cilo"))))},_={aws_project_region:"us-east-1",aws_appsync_graphqlEndpoint:"https://kponrlcw6jap7j62gb56h2abf4.appsync-api.us-east-1.amazonaws.com/graphql",aws_appsync_region:"us-east-1",aws_appsync_authenticationType:"API_KEY",aws_appsync_apiKey:"da2-jxgfvq7zzvacfozrt7vucdiipq"};t(42).default.configure(_);var U=function(){var e=window.localStorage.getItem("spotifyAccessToken"),n=window.localStorage.getItem("spotifyUsername"),t=o.a.useState(e),a=Object(c.a)(t,2),r=a[0],i=a[1],s=o.a.useState(n),l=Object(c.a)(s,2),p=l[0],f=l[1],v=o.a.useState(null),g=Object(c.a)(v,2),k=g[0],E=g[1];function w(){console.log("clearing"),window.localStorage.removeItem("spotifyAccessToken"),window.localStorage.removeItem("spotifyUsername"),i(null),f(null)}return o.a.useEffect((function(){if(r){var e=new u(r);console.log(e),E(e),e.fetchUserInfo().then((function(e){!function(e){window.localStorage.setItem("spotifyUsername",e),f(e)}(e.id)})).catch((function(){w()}))}}),[r]),o.a.createElement("div",{className:"App"},o.a.createElement(m.a,null,o.a.createElement(h,{setAccessToken:function(e){window.localStorage.setItem("spotifyAccessToken",e),i(e)}}),o.a.createElement(d,{clearAccessToken:w,accessToken:r,username:p}),o.a.createElement(y.c,null,o.a.createElement(y.a,{exact:!0,path:"/"},o.a.createElement(T,{username:p})),o.a.createElement(y.a,{path:"/u/:id"},o.a.createElement(b,{username:p,spotify:k})))))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));i.a.render(o.a.createElement(o.a.StrictMode,null,o.a.createElement(U,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[126,1,2]]]);
//# sourceMappingURL=main.a9c2a823.chunk.js.map